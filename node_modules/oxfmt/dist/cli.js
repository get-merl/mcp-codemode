import { i as runCli, n as formatFile, r as setupConfig, t as formatEmbeddedCode } from "./prettier-proxy-DtsR3p_O.js";
import { join } from "node:path";
import { readFile, stat, writeFile } from "node:fs/promises";

//#region src-js/migration/shared.ts
async function hasOxfmtrcFile(cwd) {
	return await isFile(join(cwd, ".oxfmtrc.json")) || await isFile(join(cwd, ".oxfmtrc.jsonc"));
}
const SCHEMA_RELATIVE_PATH = "./node_modules/oxfmt/configuration_schema.json";
async function hasSchemaFile(cwd) {
	return await isFile(join(cwd, "node_modules/oxfmt/configuration_schema.json")) ? SCHEMA_RELATIVE_PATH : null;
}
async function createBlankOxfmtrcFile(cwd) {
	const config = {
		$schema: await hasSchemaFile(cwd),
		ignorePatterns: []
	};
	if (config.$schema === null) delete config.$schema;
	return config;
}
async function saveOxfmtrcFile(cwd, jsonStr) {
	await writeFile(join(cwd, ".oxfmtrc.json"), jsonStr + "\n", "utf8");
}
function exitWithError(message) {
	console.error(message);
	process.exitCode = 1;
}
async function isFile(path) {
	try {
		return (await stat(path)).isFile();
	} catch {
		return false;
	}
}

//#endregion
//#region src-js/migration/init.ts
/**
* Run the `--init` command to scaffold a default `.oxfmtrc.json` file.
*/
async function runInit() {
	const cwd = process.cwd();
	if (await hasOxfmtrcFile(cwd)) return exitWithError("Oxfmt configuration file already exists.");
	const oxfmtrc = await createBlankOxfmtrcFile(cwd);
	const jsonStr = JSON.stringify(oxfmtrc, null, 2);
	try {
		await saveOxfmtrcFile(cwd, jsonStr);
		console.log("Created `.oxfmtrc.json`.");
	} catch {
		return exitWithError("Failed to create `.oxfmtrc.json`.");
	}
}

//#endregion
//#region src-js/migration/migrate-prettier.ts
/**
* Run the `--migrate prettier` command to migrate various Prettier's config to `.oxfmtrc.json` file.
* https://prettier.io/docs/configuration
*/
async function runMigratePrettier() {
	const cwd = process.cwd();
	if (await hasOxfmtrcFile(cwd)) return exitWithError("Oxfmt configuration file already exists.");
	const { resolveConfigFile, resolveConfig } = await import("./prettier-BAX-9y1Y.js");
	const prettierConfigPath = await resolveConfigFile(join(cwd, "dummy.js"));
	if (!prettierConfigPath) {
		console.log("No Prettier configuration file found.");
		const oxfmtrc$1 = await createBlankOxfmtrcFile(cwd);
		const jsonStr$1 = JSON.stringify(oxfmtrc$1, null, 2);
		try {
			await saveOxfmtrcFile(cwd, jsonStr$1);
			console.log("Created `.oxfmtrc.json` instead.");
		} catch {
			exitWithError("Failed to create `.oxfmtrc.json`.");
		}
		return;
	}
	let prettierConfig;
	try {
		prettierConfig = await resolveConfig(prettierConfigPath, { editorconfig: false });
		console.log("Found Prettier configuration at:", prettierConfigPath);
	} catch {
		return exitWithError(`Failed to parse: ${prettierConfigPath}`);
	}
	const oxfmtrc = await createBlankOxfmtrcFile(cwd);
	for (const [key, value] of Object.entries(prettierConfig ?? {})) {
		if (key === "overrides") {
			console.error(`  - "overrides" is not supported, skipping...`);
			continue;
		}
		if (key === "plugins") {
			console.error(`  - "plugins" is not supported yet, skipping...`);
			continue;
		}
		if (key === "endOfLine" && value === "auto") {
			console.error(`  - "endOfLine: auto" is not supported, skipping...`);
			continue;
		}
		if (key === "experimentalTernaries" || key === "experimentalOperatorPosition") {
			console.error(`  - "${key}" is not supported in JS/TS files yet`);
			continue;
		}
		oxfmtrc[key] = value;
	}
	if (typeof oxfmtrc.printWidth !== "number") {
		console.error(`  - "printWidth" is not set in Prettier config, defaulting to 80 (Oxfmt default: 100)`);
		oxfmtrc.printWidth = 80;
	}
	if (oxfmtrc.embeddedLanguageFormatting !== "off") console.error(`  - "embeddedLanguageFormatting" in JS/TS files is not fully supported yet`);
	const ignores = await resolvePrettierIgnore(cwd);
	if (0 < ignores.length) {
		oxfmtrc.ignorePatterns = ignores;
		console.log("Migrated ignore patterns from `.prettierignore`");
	}
	const jsonStr = JSON.stringify(oxfmtrc, null, 2);
	try {
		await saveOxfmtrcFile(cwd, jsonStr);
		console.log("Created `.oxfmtrc.json`.");
	} catch {
		return exitWithError("Failed to create `.oxfmtrc.json`.");
	}
}
async function resolvePrettierIgnore(cwd) {
	const ignores = [];
	try {
		const lines = (await readFile(join(cwd, ".prettierignore"), "utf8")).split("\n");
		for (let line of lines) {
			line = line.trim();
			if (line === "" || line.startsWith("#")) continue;
			ignores.push(line);
		}
	} catch {}
	return ignores;
}

//#endregion
//#region src-js/cli.ts
(async () => {
	const [mode, exitCode] = await runCli(process.argv.slice(2), setupConfig, formatEmbeddedCode, formatFile);
	switch (mode) {
		case "init":
			await runInit();
			break;
		case "migrate:prettier":
			await runMigratePrettier();
			break;
		default:
			if (exitCode) process.exitCode = exitCode;
			break;
	}
})();

//#endregion
export {  };